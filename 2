# frozen_string_literal: true

require "chunky_png"

module Phosphor
  module Objects
    class Image < Base
      attr_accessor :x_pos, :y_pos,
                    :scale

      def initialize(
        image_path,
        x_pos = 0,
        y_pos = 0,
        scale = 1,
        x_anchor: :start,
        y_anchor: :start
      )
        @x_pos = x_pos
        @y_pos = y_pos
        @scale = scale

        @image = ChunkyPNG::Image.from_file(image_path)

        @width = @image.width
        @height = @image.height

        @x_anchor = x_anchor
        @y_anchor = y_anchor

        super
      end

      def anchor_from(anchor, dimension)
        case anchor
        when :start
          0
        when :middle
          dimension / 2
        when :end
          dimension
        end
      end

      def x_pos_start = @x_pos - anchor_from(@x_anchor, @width)
      def x_pos_end = x_pos_start + @width

      def y_pos_start = @y_pos - anchor_from(@x_anchor, @height) / 2
      def y_pos_end = y_pos_start + @height / 2

      def render
        x_start = x_pos_start
        x_end = x_pos_end

        y_start = y_pos_start
        y_end = y_pos_end

        canvas = app_instance.canvas

        x_start.upto(x_end) do |x_pos|
          y_start.upto(y_end) do |y_pos|
            canvas.print_at(x_pos, y_pos, "â–ˆ", self,
                            color_pair: Rendering::ColorPair.from_foreground_hex(@image[x_pos, y_pos].to_s(16).rjust(6, "0")))
          end
        end
      end
    end
  end
end
